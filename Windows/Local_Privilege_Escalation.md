# Local Privilege Escalation

Common paths for local privilege escalation are:

- Missing Patches
- Automated deployment and AutoLogon passwords in clear text
- AlwaysInstalledElevated (Any user can run MSI as System)
- Misconfigured Serivces
- DLL Hijacking and more

The following Tools can be used for complete coverage:

[PowerShellMafia/PowerSploit](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)

[AlessandroZ/BeRoot](https://github.com/AlessandroZ/BeRoot)

[enjoiz/Privesc](https://github.com/enjoiz/Privesc)

[WinPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)

## Service issues using PowerUp

There are multiple checks that can be done with PowerUp, but with a focus on Services, the following are commands that can be run for specific purposes.  

### Unquoted Service Paths

```powershell
PS C:\ad\Tools> Get-ServiceUnquoted

ServiceName    : AbyssWebServer
Path           : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiablePath : @{ModifiablePath=C:\WebServer; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AbyssWebServer' -Path <HijackPath>
CanRestart     : True

ServiceName    : AbyssWebServer
Path           : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiablePath : @{ModifiablePath=C:\WebServer; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AbyssWebServer' -Path <HijackPath>
CanRestart     : True
```

### Write to Binary Path or Change Arguments (Current User)

```powershell
PS C:\ad\Tools> Get-ModifiableServiceFile

ServiceName                     : AbyssWebServer
Path                            : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiableFile                  : C:\WebServer\Abyss Web Server\WebServer
ModifiableFilePermissions       : AppendData/AddSubdirectory
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AbyssWebServer'
CanRestart                      : True

ServiceName                     : AbyssWebServer
Path                            : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiableFile                  : C:\WebServer\Abyss Web Server\WebServer
ModifiableFilePermissions       : WriteData/AddFile
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AbyssWebServer'
CanRestart                      : True

ServiceName                     : gupdate
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /svc
ModifiableFile                  : C:\
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
ModifiableFileIdentityReference : Everyone
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdate'
CanRestart                      : False
```

Pay attention to the account in the field `StartName` and also whether the service is able to be restarted

### Modify Service Configuration

```powershell
PS C:\ad\Tools> Get-ModifiableService

ServiceName   : AbyssWebServer
Path          : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'AbyssWebServer'
CanRestart    : True

ServiceName   : SNMPTRAP
Path          : C:\Windows\System32\snmptrap.exe
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'SNMPTRAP'
CanRestart    : True
```

## All Checks

### PowerUp

```powershell
PS C:\ad\Tools> Invoke-AllChecks

[*] Running Invoke-AllChecks

[*] Checking if user is in a local group with administrative privileges...

[*] Checking for unquoted service paths...

ServiceName    : AbyssWebServer
Path           : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiablePath : @{ModifiablePath=C:\WebServer; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AbyssWebServer' -Path <HijackPath>
CanRestart     : True

ServiceName    : AbyssWebServer
Path           : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiablePath : @{ModifiablePath=C:\WebServer; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AbyssWebServer' -Path <HijackPath>
CanRestart     : True

[*] Checking service executable and argument permissions...

ServiceName                     : AbyssWebServer
Path                            : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiableFile                  : C:\WebServer\Abyss Web Server\WebServer
ModifiableFilePermissions       : AppendData/AddSubdirectory
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AbyssWebServer'
CanRestart                      : True

ServiceName                     : AbyssWebServer
Path                            : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
ModifiableFile                  : C:\WebServer\Abyss Web Server\WebServer
ModifiableFilePermissions       : WriteData/AddFile
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AbyssWebServer'
CanRestart                      : True

ServiceName                     : gupdate
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /svc
ModifiableFile                  : C:\
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
ModifiableFileIdentityReference : Everyone
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdate'
CanRestart                      : False

ServiceName                     : gupdate
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /svc
ModifiableFile                  : C:\
ModifiableFilePermissions       : AppendData/AddSubdirectory
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdate'
CanRestart                      : False

ServiceName                     : gupdate
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /svc
ModifiableFile                  : C:\
ModifiableFilePermissions       : WriteData/AddFile
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdate'
CanRestart                      : False

ServiceName                     : gupdatem
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /medsvc
ModifiableFile                  : C:\
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
ModifiableFileIdentityReference : Everyone
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdatem'
CanRestart                      : False

ServiceName                     : gupdatem
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /medsvc
ModifiableFile                  : C:\
ModifiableFilePermissions       : AppendData/AddSubdirectory
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdatem'
CanRestart                      : False

ServiceName                     : gupdatem
Path                            : "C:\Program Files (x86)\Google\Update\GoogleUpdate.exe" /medsvc
ModifiableFile                  : C:\
ModifiableFilePermissions       : WriteData/AddFile
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'gupdatem'
CanRestart                      : False

[*] Checking service permissions...

ServiceName   : AbyssWebServer
Path          : C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'AbyssWebServer'
CanRestart    : True

ServiceName   : SNMPTRAP
Path          : C:\Windows\System32\snmptrap.exe
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'SNMPTRAP'
CanRestart    : True

[*] Checking %PATH% for potentially hijackable DLL locations...

ModifiablePath    : C:\Python27\
IdentityReference : BUILTIN\Users
Permissions       : AppendData/AddSubdirectory
%PATH%            : C:\Python27\
AbuseFunction     : Write-HijackDll -DllPath 'C:\Python27\\wlbsctrl.dll'

ModifiablePath    : C:\Python27\
IdentityReference : BUILTIN\Users
Permissions       : WriteData/AddFile
%PATH%            : C:\Python27\
AbuseFunction     : Write-HijackDll -DllPath 'C:\Python27\\wlbsctrl.dll'

ModifiablePath    : C:\Users\student141\AppData\Local\Microsoft\WindowsApps
IdentityReference : dcorp\student141
Permissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
%PATH%            : C:\Users\student141\AppData\Local\Microsoft\WindowsApps
AbuseFunction     : Write-HijackDll -DllPath 'C:\Users\student141\AppData\Local\Microsoft\WindowsApps\wlbsctrl.dll'

[*] Checking for AlwaysInstallElevated registry key...

[*] Checking for Autologon credentials in registry...

[*] Checking for modifidable registry autoruns and configs...

[*] Checking for modifiable schtask files/configs...

[*] Checking for unattended install files...

[*] Checking for encrypted web.config strings...

[*] Checking for encrypted application pool and virtual directory passwords...

[*] Checking for plaintext passwords in McAfee SiteList.xml files....

[*] Checking for cached Group Policy Preferences .xml files....
```

### BeRoot

The following is the syntax of running the command

```powershell
PS C:\ad\Tools> .\beRoot\beRoot.exe -h
|====================================================================|
|                                                                    |
|                    Windows Privilege Escalation                    |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

usage: beRoot.exe [-h] [-l] [-w] [-c CMD]

Windows Privilege Escalation

optional arguments:
  -h, --help         show this help message and exit
  -l, --list         list all softwares installed (not run by default)
  -w, --write        write output
  -c CMD, --cmd CMD  cmd to execute for the webclient check (default: whoami)
```

The following is a modified sample output of the command

```powershell
PS C:\ad\Tools> .\beRoot\beRoot.exe
|====================================================================|
|                                                                    |
|                    Windows Privilege Escalation                    |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

################ Service ################

[!] Permission to create a service with openscmanager
True

[!] Check services that could its configuration could be modified
Permissions: change config: True / start: True / stop: True
Name: AbyssWebServer
Display Name: Abyss Web Server

Permissions: change config: True / start: True / stop: True
Name: SNMPTRAP
Display Name: SNMP Trap

[!] Path containing spaces without quotes
permissions: {'change_config': True, 'start': True, 'stop': True}
Key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AbyssWebServer
Full path: C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
Name: AbyssWebServer
Writables path found:
        - C:\WebServer

[!] Binary located on a writable directory
permissions: {'change_config': True, 'start': True, 'stop': True}
Key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AbyssWebServer
Full path: C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service
Writable directory: C:\WebServer\Abyss Web Server\WebServer
Name: AbyssWebServer

permissions: {'change_config': False, 'start': False, 'stop': False}
Key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AJRouter
Full path: C:\Windows\system32\svchost.exe -k LocalServiceNetworkRestricted
Writable directory: C:\Windows\system32
Name: AJRouter

permissions: {'change_config': False, 'start': False, 'stop': False}
Key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ALG
Full path: C:\Windows\System32\alg.exe
Writable directory: C:\Windows\System32
Name: ALG

<snip....>

################ Taskscheduler ################

[!] Permission to write on the task directory: c:\windows\system32\tasks
True

-------------- Get System Priv with WebClient --------------

[!] Checking WebClient vulnerability

################ Error on: check_webclient ################
Traceback (most recent call last):
  File "beroot\run_checks.py", line 315, in check_all
  File "beroot\run_checks.py", line 277, in check_webclient
  File "beroot\modules\checks\webclient\webclient.py", line 206, in run
  File "beroot\modules\checks\webclient\webclient.py", line 101, in startWebclient
ValueError: Procedure probably called with not enough arguments (4 bytes missing)

[!] Elapsed time = 1.0490000248
```

### PrivEsc

```powershell
PS C:\ad\Tools> Invoke-Privesc
Date of last applied patch - just use public exploits if not patched:
8/17/2020

----------------------------------------------------------------------

Files that may contain Administrator password - you know what to do with this one:
C:\Windows\panther\setupinfo
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

----------------------------------------------------------------------

Checking if SCCM is installed - installers are run with SYSTEM privileges, many are vulnerable to DLL Sideloading:
Get-WmiObject : Invalid namespace "root\ccm\clientSDK"
At C:\ad\Tools\Privesc-master\privesc.ps1:209 char:19
+ ...   $result = Get-WmiObject -Namespace "root\ccm\clientSDK" -Class CCM_ ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidArgument: (:) [Get-WmiObject], ManagementException
    + FullyQualifiedErrorId : GetWMIManagementException,Microsoft.PowerShell.Commands.GetWmiObjectCommand

Not Installed.

----------------------------------------------------------------------

Checking AlwaysInstallElevated - install *.msi files as NT AUTHORITY\SYSTEM - exploit/windows/local/always_install_elevated:
Registries not found.

----------------------------------------------------------------------

Checking privileges - rotten potato:
User privileges do not allow for rotten potato exploit.

----------------------------------------------------------------------

Checking if WSUS uses HTTP - eg. WSUXploit:
Get-ItemProperty : Property WUServer does not exist at path HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate.
At C:\ad\Tools\Privesc-master\privesc.ps1:244 char:83
+ ... sUpdate) { (Get-ItemProperty -Path HKLM:\Software\Policies\Microsoft\ ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidArgument: (WUServer:String) [Get-ItemProperty], PSArgumentException
    + FullyQualifiedErrorId : System.Management.Automation.PSArgumentException,Microsoft.PowerShell.Commands.GetItemPropertyCommand

----------------------------------------------------------------------

Services with space in path and not enclosed with quotes - if you have permissions run executable from different directory - exploit/windows/local/trusted_service_path:
C:\WebServer\Abyss Web Server\WebServer\abyssws.exe --service

----------------------------------------------------------------------

PATH variable entries permissions - place binary or DLL to execute before legitimate
Group: student141, Permissions: FullControl on C:\Python27\
Group: Users, Permissions: AppendData on C:\Program Files\Java\jdk-11.0.2\bin
Group: Users, Permissions: CreateFiles on C:\Program Files\Java\jdk-11.0.2\bin

----------------------------------------------------------------------

System32 directory permissions - backdoor windows binaries:
Permissions set on System32 directory are correct for all groups.

----------------------------------------------------------------------

System32 files and directories permissions - backdoor windows binaries:
Group: Users, Permissions: CreateFiles, ReadAndExecute, Synchronize on C:\Windows\system32\spool\drivers\color

----------------------------------------------------------------------

Windows Temp directory read permissions - DLL Sideloading each created directory:
Get-Acl : Attempted to perform an unauthorized operation.
At C:\ad\Tools\Privesc-master\privesc.ps1:299 char:20
+         $result = (Get-Acl C:\Windows\Temp).Access | ForEach-Object { ...
+                    ~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [Get-Acl], UnauthorizedAccessException
    + FullyQualifiedErrorId : System.UnauthorizedAccessException,Microsoft.PowerShell.Commands.GetAclCommand

Permissions set on Windows Temp directory are correct for all groups.

----------------------------------------------------------------------

Program Files directory permissions - backdoor windows binaries:
Permissions set on Program Files directory are correct for all groups.

----------------------------------------------------------------------

Program Files files and directories permissions - backdoor windows binaries:
Permissions set on Program Files files and directories are correct for all groups.

----------------------------------------------------------------------

All users startup permissions - execute binary with permissions of logged user:
Permissions set on All Users startup files and directories are correct for all groups.

----------------------------------------------------------------------

Startup executables permissions - backdoor startup binaries and check if they are also run at startup by other users:
Get-ItemProperty : Cannot find path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce' because it does not exist.
At C:\ad\Tools\Privesc-master\privesc.ps1:352 char:20
+ ...  $result += Get-ItemProperty -Path hkcu:\Software\Microsoft\Windows\C ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (HKCU:\Software\...Version\RunOnce:String) [Get-ItemProperty], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetItemPropertyCommand

Permissions set on startup executables are correct for all groups.

----------------------------------------------------------------------

Startup executables directory permissions - try DLL injection:
Get-ItemProperty : Cannot find path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce' because it does not exist.
At C:\ad\Tools\Privesc-master\privesc.ps1:366 char:20
+ ...  $result += Get-ItemProperty -Path hkcu:\Software\Microsoft\Windows\C ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (HKCU:\Software\...Version\RunOnce:String) [Get-ItemProperty], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetItemPropertyCommand

Permissions set on startup executables directories are correct for all groups.

----------------------------------------------------------------------

Checking permissions on uninstall registy keys and subkeys (changing binary paths):
Permissions set on uninstall registry keys and subkeys are correct for all groups.

----------------------------------------------------------------------

Checking services permissions - change BINARY_PATH_NAME of a service:
Permissions set on services are correct for all groups. Double check - each part of SDDL should have A as Allow at the beginning.

----------------------------------------------------------------------

Checking permissions on services registy keys and subkeys (changing ImagePath value of a service):
Permissions set on services registry keys and subkeys are correct for all groups.

----------------------------------------------------------------------

Service binary permissions - backdoor service binary:
Permissions set on service binaries are correct for all groups.

----------------------------------------------------------------------

Service directory permissions - try DLL injection:
Group: Users, Permissions: AppendData on C:\WebServer\Abyss Web Server\WebServer
Group: Users, Permissions: CreateFiles on C:\WebServer\Abyss Web Server\WebServer

----------------------------------------------------------------------

Process binary permissions - backdoor process binary:
Permissions set on process binaries are correct for all groups.

----------------------------------------------------------------------

Process directory permissions - try DLL injection:
Permissions set on process directories are correct for all groups.

----------------------------------------------------------------------

Scheduled process binary permissions - backdoor binary:
Permissions set on scheduled binaries are correct for all groups.

----------------------------------------------------------------------

Scheduled process directory permissions - try DLL injection:
Group: Users, Permissions: AppendData on \
Group: Users, Permissions: CreateFiles on \

----------------------------------------------------------------------

Loaded DLLs permissions - backdoor DLL:
Permissions set on loaded DLLs are correct for all groups.

----------------------------------------------------------------------
```