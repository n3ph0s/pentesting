# Tools

## PowerView

PowerView can be found at [PowerView - Master](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) with the Development Tools at [PowerView - Development](https://github.com/PowerShellMafia/PowerSploit/tree/dev/Recon).

Tips for using PowerView can be found at [PowerView 3.0 Tricks](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

# Enumeration 

## Domain

Get Domain

``` PowerShell
Get-NetDomain
Get-NetDomain -Domain domain.local

```

Get Domain SID 

``` PowerShell
Get-DomainSID
Get-DomainSID -Domain domain.local
```

Get Domain Policy

``` PowerShell
Get-DomainPolicy
(Get-DomainPolicy)."system access"
(Get-DomainPolicy -Domain domain.local)."kerberos policy"
``` 

Get Domain Controllers
``` PowerShell
Get-NetDomainController
Get-NetDomainController -Domain domain.local
``` 

## Users

Get a list of users in the current domain

``` PowerShell
Get-NetUser | select samaccountname
Get-NetUser -Username student1
```

To list all properties for users or to find a specific value

``` PowerShell
Get-UserProperty
Get-UserProperty -Properties description | where description -ne $null
Get-UserProperty -Properties pwdlastset
Get-NetUser | where description -ne $null | select cn, description
```

To find a particular string in the users attributes

``` PowerShell
Find-UserField -SearchTerm "built"
Find-UserField -SearchField Description -SearchTerm "built"
```

## Groups

List all Groups in a Domain

``` PowerShell
Get-NetGroup
Get-NetGroup -domain <targetdomain>
Get-NetGroup -FullData
``` 

List all Groups containing the word "admin" in name

``` PowerShell
Get-NetGroup *admin*
```

Get Members of the Group Domain Admins

``` PowerShell
Get-NetGroupMember -GroupName "Domain Admins" -Recurse
Get-NetGroupMember -GroupName "Domain Admins" -Recurse -Domain <targetdomain>
```

Get the Group Membership for a specific user

``` PowerShell
Get-NetGroup -UserName student1
```

## Computers / Session Information

Get a list of computers in domain

``` PowerShell
Get-NetComputer
Get-NetComputer -OperatingSystem "*Server 2016*"
Get-ComputerProperty -Properties operatingsystem
Get-NetComputer -Ping
Get-NetComputer -FullData
``` 

Get a list of Local Groups and Memberships

``` PowerShell
Get-NetLocalGroup -ComputerName dcorp-std141 -ListGroups
Get-NetLocalGroup -ComputerName dcorp-std141 -Recurse
```

Get current logged on users on target (Admin rights needed on target)

``` PowerShell
Get-NetLoggedOn -ComputerName <target>
```

Get locally logged on users on target (needs remote registry enabled which is started by default on servers)

``` PowerShell
Get-LoggedOnLocal -ComputerName dcorp-dc
```

Get the last logged on user on target (requires admin rights and remote registry enabled)

``` PowerShell
Get-LastLoggedOn -ComputerName
```

## Shares

Find shares on hosts in domain

``` PowerShell
Invoke-ShareFinder
Invoke-ShareFinder -Domain <targetdomain>
Invoke-ShareFinder -ExcludeStandard
``` 

Find readable files on the domain with 'pass', 'sensitive', 'secret', 'admin', 'login', or unattend.xml' in the name
``` PowerShell
Invoke-FileFinder
```

Get list of all file servers extracted from user homedirectory, scriptpath, and profilepath fields.

``` PowerShell
Get-NetFileServer
```

## OU / GPO

List all OU's

``` PowerShell
Get-NetOU
Get-NetOU -FullData
Get-NetOU -Domain <targetdomain>
``` 

Get list of computers in a specified OU

``` PowerShell
Get-NetComputer -FullData | where adspath -Like "*OU=StudentMachine*"
Get-NetOU -OUName StudentMachines | %{Get-NetComputer -ADSpath $_}
```

To list GPO's

``` PowerShell
Get-NetGPO
```

To get GPO applied to an OU (First query the NetOU to get the CN for the gplink)

``` PowerShell
Get-NetGPO -GPOname '{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'
```

## ACLs

To get Object ACL's

``` PowerShell
Get-ObjectAcl -ResolveGUIDs
``` 

To get Object ACL's for a specific group

``` PowerShell
Get-NetGroup -GroupName Users -FullData | Get-ObjectAcl -ResolveGUIDs
Get-ObjectAcl -SamAccountName "users" -ResolveGUIDs
```

To search for Interesting ACE's

``` PowerShell
Invoke-ACLScanner -ResolveGUIDs
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReference -match "rdpusers"}
```

## Forest, Domains and Trusts

Forest Mapping

``` PowerShell
Get-NetForest
Get-NetForest -Forest eurocorp.local
``` 

Get all domains in Forest

``` PowerShell
Get-NetForestDomain 
Get-NetForestDomain –Forest eurocorp.local
```

Get all Global Catalogs in Forest

``` PowerShell
Get-NetForestCatalog
Get-NetForestCatalog -Forest eurocorp.local
```

Map Trusts of Forest

``` PowerShell
Get-NetForestTrust 
Get-NetForestTrust -Forest eurocorp.local
Get-NetForestDomain | Get-NetDomainTrust
```

Map Trusts of Domain

``` PowerShell
Get-NetDomainTrust 
Get-NetDomainTrust -Domain moneycorp.local
Get-NetForestDomain | Get-NetDomainTrust
```
# User Hunting - PowerView

Find all the machines on the current or specified domain where the user executing the script has local admin access.  This function queries the DC for a list of computers with `Get-NetComputers` and then uses `Invoke-CheckLocalAdminAccess` on each of the machines (This is very loud and generates a LOT of log events).  In addition, to this you can also pass in a file with a list of computer names to check or individual machines for more targetted queries.

``` PowerShell
Find-LocalAdminAccess

# Alternatives to the above in the event that SMB and RPC may not be open which is a requirement for `Find-LocalAdminAccess`

Find-WMILocalAdminAccess
Find-PSRemotingLocalAdminAccess
```

Find local admins on all machines in the domain.  Needs Administrator privileges on Non-DC machines

``` PowerShell
Invoke-EnumerateLocalAdmin 
Invoke-EnumerateLocalAdmin -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local
```

Find computers where a domain admin or specified group has sessions.  This function queries the DC of the current or specified domain for metbers of the group (Domain Admins by defrault) using 'Get-NetGroupMember', gets a list of computers using `Get-NetComputer` and lists sessions and logged on users usingt `GetNetSession` or `Get-NetLoggedOn` from each machine.

``` PowerShell
Invoke-UserHunter
Invoke-UserHunter -GroupName "RDPUsers"
Invoke-UserHunter -Stealth  #Only searchs DC, File Servers and DFS
```

**Note**: When you have found successful results from the above search you can use the `-checkaccess` parameter to verify that admin access is confirmed.

# Privilege Escalation

Kerberoasting - Find users accounts being used as Service Accounts

``` PowerShell
Get-NetUser -SPN
Get-NetUser -SPN | select cn,serviceprincipalname
``` 

AS-Rep Roasting

``` PowerShell
Get-DomainUser -PreauthNotRequired
```

Unconstrained Delegation

``` PowerShell
Get-NetComputer -Unconstrained 
Get-NetComputer -Unconstrained | select cn
```

Constrained Delegation

``` PowerShell
Get-DomainUser –TrustedToAuth 
Get-DomainComputer –TrustedToAuth
```